<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>关于DART/WRF的精度问题 - JUJUnotebook</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u5173\u4e8eDART/WRF\u7684\u7cbe\u5ea6\u95ee\u9898";
    var mkdocs_page_input_path = "experiment/real_precise.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> JUJUnotebook</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">HOME</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../changelog/">Changelog</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Bike</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../bike/chain_len/">链条长度的确定</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../bike/silkroad/">Silkroad</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Blog</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../blog/encrypt_template/">[Protected] encrypt_template</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../blog/mkdocs_rtd_githubpage/">如何建立一个blog？</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Experiment</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../dart_quantile/">[Protected] DART_QCEFF</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">关于DART/WRF的精度问题</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_1">关于内存占用</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#quantile_method-bug">关于精度改变导致的quantile_method bug</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Linux</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../linux/2023-06-25-email-in-linux/">在linux服务器上自动发邮件</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../linux/Automatic%20script%20header%20in%20VSCode/">Automatic script header in VSCode</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../linux/intro_to_linux/">关于远程服务器的coding</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">JUJUnotebook</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Experiment &raquo;</li>
        
      
    
    <li>关于DART/WRF的精度问题</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="dartwrf">关于DART/WRF的精度问题</h1>
<h2 id="_1">关于内存占用</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Modify the DART code to use 32bit reals. Most WRF/DART users run both the WRF model and the DART assimilation code using 32bit reals. This is not the default for the DART code. Make this single code change before building the DART executables to compile all reals as 32bit reals.</p>
</div>
<p>更多相关的信息请参看<a href="https://docs.dart.ucar.edu/en/latest/models/wrf/tutorial/README.html#build-the-dart-executables">WRF/DART tutorial</a> 简而言之，WRF使用单精度浮点数(4个字节，32 bit real number)，而DART默认使用的是64bit real(双精度浮点数)，这在进行内存需求量很大的运算时会要求额外许多的核数，我使用64bit real提交了1200个core到mpi都会报错内存不足，用32bit real的话600 core一下子就能跑了......</p>
<h2 id="quantile_method-bug">关于精度改变导致的quantile_method bug</h2>
<p>邮件咨询了一下DART，下面是邮件记录：</p>
<hr />
<p>Dear DARES members:</p>
<p>Im a graduate student at Nanjing University, and is trying to use DART quantile_method branch to do something. I encountered a bug in this branch, maybe is correlated with the real precision. Here is what happened:</p>
<p>im assimilating OSSE obs into WRF with fine model resolution, which need a large memory, so i change the real precision by editing $DART_DIR/assimilation_code/modules/utilities/types_mod.f90 follows this guide https://docs.dart.ucar.edu/en/latest/models/wrf/tutorial/README.html#build-the-dart-executables. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>! real precision:</p>
<p>! TO RUN WITH REDUCED PRECISION REALS (and use correspondingly less memory)</p>
<p>! comment OUT the r8 definition below and use the second one:</p>
<p>integer, parameter :: r4 = SELECTED_REAL_KIND(6,30)</p>
<p>integer, parameter :: r8 = SELECTED_REAL_KIND(12)   ! 8 byte reals</p>
<p>!integer, parameter :: r8 = r4                      ! alias r8 to r4</p>
</div>
<p>after a quickbuild recompile, the filter is re-submitted, and it abort with these message:</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>ERROR FROM:</p>
<p>source : rh_distribution_mod.f90</p>
<p>routine: inv_rh_cdf</p>
<p>message:  x less than lower_bound           19 -2.0822274E-15</p>
</div>
<p>i have tried the two real precision in a coarser grid case, r8 goes smoothly without any problem, and r4 will encounter the same error:</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>ERROR FROM:</p>
<p>source : rh_distribution_mod.f90</p>
<p>routine: inv_rh_cdf</p>
<p>message:  x less than lower_bound           11 -4.1970271E-16</p>
</div>
<p>The error part of code in inv_rh_cdf says:</p>
<pre><code class="language-fortran">   ! Check for posterior violating bounds; This may not be needed after development testing
   if(bounded_below) then
      if(x(i) &lt; lower_bound) then
         write(errstring, *) 'x less than lower_bound ', i, x(i)
         call error_handler(E_ERR, 'inv_rh_cdf', errstring, source)
      endif
   endif

   if(bounded_above) then
      if(x(i) &gt; upper_bound) then
         write(errstring, *) 'x greater than upper_bound ', i, x(i)
         call error_handler(E_ERR, 'inv_rh_cdf', errstring, source)
      endif
   endif
</code></pre>
<p>Seems it is ok to just ignore these error by commenting out this part of code? Or is it needed to polish the check so it can ignore the small bound violation brought by real precision? I checked the newest quantile_method branch in Github, the source code where things went wrong may have changed to 'rh_distribution_mod.f90'.</p>
<p>Thanks for any reply~</p>
<p>Haoxing</p>
<hr />
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../linux/2023-06-25-email-in-linux/" class="btn btn-neutral float-right" title="在linux服务器上自动发邮件">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../dart_quantile/" class="btn btn-neutral" title="[Protected] DART_QCEFF"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../dart_quantile/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../linux/2023-06-25-email-in-linux/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
